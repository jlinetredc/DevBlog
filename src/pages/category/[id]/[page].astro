---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getAssetPath } from '../../../lib/utils';
import { CATEGORIES, getCategoryLabel } from '../../../lib/categories';
import { SITE_CONFIG } from '../../../lib/constants';

export async function getStaticPaths({ paginate }) {
    const allPosts = await getCollection('blog');
    const categoryList = Object.values(CATEGORIES);

    // Lặp qua từng category để tạo trang riêng cho nó
    return categoryList.flatMap((cat) => {
        const filteredPosts = allPosts
            .filter(post => post.data.category === cat.id)
            .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

        // Phân trang cho category này, mỗi trang 12 bài
        return paginate(filteredPosts, {
            params: { id: cat.id },
            pageSize: SITE_CONFIG.pageSize,
            props: { totalCount: filteredPosts.length }
        });
    });
}

const { page } = Astro.props;
const { id } = Astro.params;
const { currentPage, lastPage } = page;
const displayLabel = getCategoryLabel(id);


const pageNumbers = Array.from({ length: lastPage }, (_, i) => i + 1);

const allPostsInCategory = await getCollection('blog', ({ data }) => {
    return data.category === id;
});
const manualTotal = allPostsInCategory.length;
---

<Layout title={`Chủ đề: ${displayLabel} - Trang ${currentPage}`}>
    <header class="py-12 border-b border-slate-100 mb-12">
        <a href={getAssetPath('/')} class="text-sm text-slate-400 hover:text-orange-600 transition-colors mb-4 inline-block">
            ← Tất cả bài viết
        </a>
        <div class="flex items-center gap-4">
            <h1 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tight">
                Chủ đề: <span class="text-orange-600">{displayLabel}</span>
            </h1>
            <span class="px-3 py-1 bg-slate-100 text-slate-500 text-xs font-bold rounded-full mt-2">
                {manualTotal} bài viết
            </span>
        </div>
        <p class="text-slate-500 mt-4 text-lg max-w-2xl">
            Tổng hợp các bài viết chia sẻ kiến thức và kinh nghiệm về {displayLabel}.
        </p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {page.data.map(post => <PostCard post={post} />)}
    </div>

    {lastPage > 1 && (
        <nav class="mt-20 flex justify-center items-center gap-2">
            {page.url.prev && (
                <a href={getAssetPath(page.url.prev)} class="w-10 h-10 flex items-center justify-center rounded-lg border border-slate-200 hover:text-orange-600 transition-all">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </a>
            )}

            {pageNumbers.map(num => (
                <a 
                    href={getAssetPath(num === 1 ? `/category/${id}/1` : `/category/${id}/${num}`)}
                    class={`w-10 h-10 flex items-center justify-center rounded-lg font-bold text-sm transition-all ${
                        currentPage === num 
                        ? "bg-orange-600 text-white shadow-lg" 
                        : "bg-white border border-slate-200 text-slate-600 hover:border-orange-500"
                    }`}
                >
                    {num}
                </a>
            ))}

            {page.url.next && (
                <a href={getAssetPath(page.url.next)} class="w-10 h-10 flex items-center justify-center rounded-lg border border-slate-200 hover:text-orange-600 transition-all">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
            )}
        </nav>
    )}
</Layout>